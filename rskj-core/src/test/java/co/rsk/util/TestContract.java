package co.rsk.util;

import org.ethereum.core.CallTransaction;
import org.ethereum.util.RskTestFactory;
import org.ethereum.vm.program.ProgramResult;
import org.spongycastle.util.encoders.Hex;

import java.math.BigInteger;
import java.util.HashMap;
import java.util.Map;

public class TestContract {
    public final String bytecode;
    public final String runtimeBytecode;
    public final Map<String, CallTransaction.Function> functions;

    private TestContract(String bytecode, String runtimeBytecode, Map<String, CallTransaction.Function> functions) {
        this.bytecode = bytecode;
        this.runtimeBytecode = runtimeBytecode;
        this.functions = functions;
    }

    public static TestContract greeter() {
        /*
        contract greeter {

            address owner;
            modifier onlyOwner { if (msg.sender != owner) throw; _ ; }

            function greeter() public {
                owner = msg.sender;
            }
            function greet(string param) onlyOwner constant returns (string) {
                return param;
            }
        }
        */

        String bytecode = "6060604052341561000f57600080fd5b336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506101c78061005e6000396000f300606060405260043610610041576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063ead710c414610046575b600080fd5b341561005157600080fd5b6100a1600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190505061011c565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100e15780820151818401526020810190506100c6565b50505050905090810190601f16801561010e5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b610124610187565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561017f57600080fd5b819050919050565b6020604051908101604052806000815250905600a165627a7a723058202aca6463346768bbaa3b9b3952b0ae2a2f06b0578caa96df2497092155e739f50029";
        String runtimeBytecode = "606060405260043610610041576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063ead710c414610046575b600080fd5b341561005157600080fd5b6100a1600480803590602001908201803590602001908080601f0160208091040260200160405190810160405280939291908181526020018383808284378201915050505050509190505061011c565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100e15780820151818401526020810190506100c6565b50505050905090810190601f16801561010e5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b610124610187565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561017f57600080fd5b819050919050565b6020604051908101604052806000815250905600a165627a7a723058202aac827affd20fd4d87d358b218eab474248ca8382a5270a7178dfbf15d64ace0029";
        String abi = "[{\"constant\":true,\"inputs\":[{\"name\":\"param\",\"type\":\"string\"}],\"name\":\"greet\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"payable\":false,\"type\":\"function\"},{\"inputs\":[],\"payable\":false,\"type\":\"constructor\"}]";

        CallTransaction.Contract contract = new CallTransaction.Contract(abi);

        Map<String, CallTransaction.Function> functions = new HashMap<>();
        functions.put("greet", contract.getByName("greet"));
        return new TestContract(bytecode, runtimeBytecode, functions);
    }

    public static TestContract hello() {
        /*
        contract helloworld {
            function hello() constant returns (string) {
                return "chinchilla";
            }
        }
        */

        String bytecode = "6060604052341561000f57600080fd5b6101578061001e6000396000f300606060405260043610610041576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806319ff1d2114610046575b600080fd5b341561005157600080fd5b6100596100d4565b6040518080602001828103825283818151815260200191508051906020019080838360005b8381101561009957808201518184015260208101905061007e565b50505050905090810190601f1680156100c65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6100dc610117565b6040805190810160405280600a81526020017f6368696e6368696c6c6100000000000000000000000000000000000000000000815250905090565b6020604051908101604052806000815250905600a165627a7a723058200219de0bddb00381a60d2b887c5816e3846b3d1b6262349fc369c4b9b86d570b0029";
        String runtimeBytecode = "606060405260043610610041576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806319ff1d2114610046575b600080fd5b341561005157600080fd5b6100596100d4565b6040518080602001828103825283818151815260200191508051906020019080838360005b8381101561009957808201518184015260208101905061007e565b50505050905090810190601f1680156100c65780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6100dc610117565b6040805190810160405280600a81526020017f6368696e6368696c6c6100000000000000000000000000000000000000000000815250905090565b6020604051908101604052806000815250905600a165627a7a7230582043fd5aff0f077e6da5e30c15fdba5e724b7e4aa2c190c5ffe86f87f7bf18a47a0029";
        String abi = "[{\"constant\":true,\"inputs\":[],\"name\":\"hello\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"payable\":false,\"type\":\"function\"}]";

        CallTransaction.Contract contract = new CallTransaction.Contract(abi);

        Map<String, CallTransaction.Function> functions = new HashMap<>();
        functions.put("hello", contract.getByName("hello"));
        return new TestContract(bytecode, runtimeBytecode, functions);
    }

    public static TestContract countcalls() {
        /*
        contract countcalls {
            uint numberOfCalls = 0;

            function calls() public returns (string) {
                return appendUintToString("calls: ", ++numberOfCalls);
            }

            function appendUintToString(string inStr, uint v) constant returns (string) {
                uint maxlength = 100;
                bytes memory reversed = new bytes(maxlength);
                uint i = 0;
                while (v != 0) {
                    uint remainder = v % 10;
                    v = v / 10;
                    reversed[i++] = byte(48 + remainder);
                }
                bytes memory inStrb = bytes(inStr);
                bytes memory s = new bytes(inStrb.length + i);
                uint j;
                for (j = 0; j < inStrb.length; j++) {
                    s[j] = inStrb[j];
                }
                for (j = 0; j < i; j++) {
                    s[j + inStrb.length] = reversed[i - 1 - j];
                }
                return string(s);
            }
        }
        */

        String bytecode = "606060405260008055341561001357600080fd5b6104fd806100226000396000f30060606040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063305f72b714610051578063c80667e3146100df575b600080fd5b341561005c57600080fd5b6100646101be565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100a4578082015181840152602081019050610089565b50505050905090810190601f1680156100d15780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156100ea57600080fd5b610143600480803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091908035906020019091905050610217565b6040518080602001828103825283818151815260200191508051906020019080838360005b83811015610183578082015181840152602081019050610168565b50505050905090810190601f1680156101b05780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101c66104a9565b6102126040805190810160405280600781526020017f63616c6c733a20000000000000000000000000000000000000000000000000008152506000808154600101919050819055610217565b905090565b61021f6104a9565b60006102296104bd565b6000806102346104bd565b61023c6104bd565b600060649650866040518059106102505750595b9080825280601f01601f19166020018201604052509550600094505b60008914151561030357600a8981151561028257fe5b069350600a8981151561029157fe5b049850836030017f01000000000000000000000000000000000000000000000000000000000000000286868060010197508151811015156102ce57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535061026c565b899250848351016040518059106103175750595b9080825280601f01601f19166020018201604052509150600090505b82518110156103e057828181518110151561034a57fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f01000000000000000000000000000000000000000000000000000000000000000282828151811015156103a357fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508080600101915050610333565b600090505b84811015610499578581600187030381518110151561040057fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f010000000000000000000000000000000000000000000000000000000000000002828451830181518110151561045c57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535080806001019150506103e5565b8197505050505050505092915050565b602060405190810160405280600081525090565b6020604051908101604052806000815250905600a165627a7a723058207a21d16a0ede9f38fa032adb3ba903087c65faf91b01d02fd7aeecc5602030050029";
        String runtimeBytecode = "60606040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063305f72b714610051578063c80667e3146100df575b600080fd5b341561005c57600080fd5b6100646101be565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100a4578082015181840152602081019050610089565b50505050905090810190601f1680156100d15780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34156100ea57600080fd5b610143600480803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091908035906020019091905050610217565b6040518080602001828103825283818151815260200191508051906020019080838360005b83811015610183578082015181840152602081019050610168565b50505050905090810190601f1680156101b05780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6101c66104a9565b6102126040805190810160405280600781526020017f63616c6c733a20000000000000000000000000000000000000000000000000008152506000808154600101919050819055610217565b905090565b61021f6104a9565b60006102296104bd565b6000806102346104bd565b61023c6104bd565b600060649650866040518059106102505750595b9080825280601f01601f19166020018201604052509550600094505b60008914151561030357600a8981151561028257fe5b069350600a8981151561029157fe5b049850836030017f01000000000000000000000000000000000000000000000000000000000000000286868060010197508151811015156102ce57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535061026c565b899250848351016040518059106103175750595b9080825280601f01601f19166020018201604052509150600090505b82518110156103e057828181518110151561034a57fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f01000000000000000000000000000000000000000000000000000000000000000282828151811015156103a357fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508080600101915050610333565b600090505b84811015610499578581600187030381518110151561040057fe5b9060200101517f010000000000000000000000000000000000000000000000000000000000000090047f010000000000000000000000000000000000000000000000000000000000000002828451830181518110151561045c57fe5b9060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535080806001019150506103e5565b8197505050505050505092915050565b602060405190810160405280600081525090565b6020604051908101604052806000815250905600a165627a7a72305820264c1b1eb867072724b16b278bfebb3817f1f2e5ba8c43e1b8a75bf10cb416cb0029";
        String abi = "[{\"constant\":true,\"inputs\":[],\"name\":\"calls\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"payable\":false,\"type\":\"function\"},{\"constant\":true,\"inputs\":[{\"name\":\"inStr\",\"type\":\"string\"},{\"name\":\"v\",\"type\":\"uint256\"}],\"name\":\"appendUintToString\",\"outputs\":[{\"name\":\"str\",\"type\":\"string\"}],\"payable\":false,\"type\":\"function\"},{\"constant\":true,\"inputs\":[{\"name\":\"v\",\"type\":\"uint256\"}],\"name\":\"uintToString\",\"outputs\":[{\"name\":\"str\",\"type\":\"string\"}],\"payable\":false,\"type\":\"function\"}]";

        CallTransaction.Contract contract = new CallTransaction.Contract(abi);

        Map<String, CallTransaction.Function> functions = new HashMap<>();
        functions.put("calls", contract.getByName("calls"));
        return new TestContract(bytecode, runtimeBytecode, functions);
    }

    public static TestContract parent() {
        /*
        contract Child {
            function validateValue(uint256 val) public payable {
                assert(msg.value != val);
            }
        }
        contract Parent {
            function createChild() public payable {
                new Child().validateValue(msg.value);
            }
        }
        */

        String bytecode = "6060604052341561000f57600080fd5b6101dc8061001e6000396000f300606060405260043610610041576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063a3a4ba3114610046575b600080fd5b61004e610050565b005b6100586100f1565b604051809103906000f080151561006e57600080fd5b73ffffffffffffffffffffffffffffffffffffffff16635525c61d346040518263ffffffff167c010000000000000000000000000000000000000000000000000000000002815260040180828152602001915050600060405180830381600087803b15156100db57600080fd5b6102c65a03f115156100ec57600080fd5b505050565b60405160b08061010183390190560060606040523415600e57600080fd5b60948061001c6000396000f300606060405260043610603f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680635525c61d146044575b600080fd5b60586004808035906020019091905050605a565b005b803414151515606557fe5b505600a165627a7a72305820a8eeb8a1cf7319c3b053acace838d6bdef2ad73ca48ebe15defb9d79717975560029a165627a7a72305820788c65211d8eea2088f46f770d44a843cdf978536c0abd6b2591d53a156856860029";
        String runtimeBytecode = "606060405260043610610041576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063a3a4ba3114610046575b600080fd5b61004e610050565b005b6100586100f1565b604051809103906000f080151561006e57600080fd5b73ffffffffffffffffffffffffffffffffffffffff16635525c61d346040518263ffffffff167c010000000000000000000000000000000000000000000000000000000002815260040180828152602001915050600060405180830381600087803b15156100db57600080fd5b6102c65a03f115156100ec57600080fd5b505050565b60405160b08061010183390190560060606040523415600e57600080fd5b60948061001c6000396000f300606060405260043610603f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680635525c61d146044575b600080fd5b60586004808035906020019091905050605a565b005b803414151515606557fe5b505600a165627a7a723058200bea5b783219052a9fcfe59af9c4a1cf0343154ff10bda9b87f15f4684ef28dd0029a165627a7a723058200e99eccb76732af4236048b30d20e0385dbe572b1286e5560472e57a3a6104630029";
        String abi = "[{\"constant\":false,\"inputs\":[],\"name\":\"createChild\",\"outputs\":[],\"payable\":true,\"type\":\"function\"}]";

        CallTransaction.Contract contract = new CallTransaction.Contract(abi);

        Map<String, CallTransaction.Function> functions = new HashMap<>();
        functions.put("createChild", contract.getByName("createChild"));
        return new TestContract(bytecode, runtimeBytecode, functions);
    }

    public static TestContract msgValueTest() {
        /*
        contract Called{
            function Called() { }
        }

        contract Test{
            function test_create() payable returns(bool) {
                require(msg.value>0);
                // msg.value in the constructor should be 0
                // but it is msg.value of the caller
                // As a result msg.value > 0 in the constructor
                // and the construction fails as Called is not payable
                Called c = new Called();
            }
        }
        */
        String bytecode = "6060604052341561000f57600080fd5b6101298061001e6000396000f300606060405260043610610041576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063042b029d14610046575b600080fd5b61004e610068565b604051808215151515815260200191505060405180910390f35b60008060003411151561007a57600080fd5b61008261009e565b604051809103906000f080151561009857600080fd5b90505090565b6040516050806100ae83390190560060606040523415600e57600080fd5b603580601b6000396000f3006060604052600080fd00a165627a7a7230582075e052d0557041762d57a89ac05057a04768011dd02dd6e523dfd257210514d70029a165627a7a723058209fe4a9fe5757376392c2b75b2837e7f3d59065183f406386427bc48704589cd80029";
        String runtimeBytecode = "606060405260043610610041576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063042b029d14610046575b600080fd5b61004e610068565b604051808215151515815260200191505060405180910390f35b60008060003411151561007a57600080fd5b61008261009e565b604051809103906000f080151561009857600080fd5b90505090565b6040516050806100ae83390190560060606040523415600e57600080fd5b603580601b6000396000f3006060604052600080fd00a165627a7a7230582075e052d0557041762d57a89ac05057a04768011dd02dd6e523dfd257210514d70029a165627a7a723058209fe4a9fe5757376392c2b75b2837e7f3d59065183f406386427bc48704589cd80029";
        String abi = "[{\"constant\":false,\"inputs\":[],\"name\":\"test_create\",\"outputs\":[{\"name\":\"\",\"type\":\"bool\"}],\"payable\":true,\"type\":\"function\"}]";

        CallTransaction.Contract contract = new CallTransaction.Contract(abi);

        Map<String, CallTransaction.Function> functions = new HashMap<>();
        functions.put("test_create", contract.getByName("test_create"));
        return new TestContract(bytecode, runtimeBytecode, functions);
    }

    public static TestContract bankTest() {
        /*
        contract Bank {
            function () payable { }
        }

        contract BankTest {
            Bank bank;

            function BankTest() {
                bank = new Bank();
            }

            function test() payable {
                // send will fail as it reach the fallback function with 0 gas
                // instead of 2300
                require(bank.send(msg.value));
            }
        }
        */

        String bytecode = "6060604052341561000f57600080fd5b610017610071565b604051809103906000f080151561002d57600080fd5b6000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610080565b604051604d806101a683390190565b6101178061008f6000396000f300606060405260043610603f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063f8a8fd6d146044575b600080fd5b604a6084565b60405180826fffffffffffffffffffffffffffffffff166fffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc60019081150290604051600060405180830381858888f19350505050151560e457fe5b602b9050905600a165627a7a723058202afd2e2ba780ca7060c0a7dfd1dc667ca3a8144fc6aed9b3042949c93dae154b002960606040523415600e57600080fd5b603280601b6000396000f30060606040520000a165627a7a7230582095941e5786a3f040b17c314064c89d9b0b91d2571795bd7d7ba6628428ec47790029";
        String runtimeBytecode = "606060405260043610603f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063f8a8fd6d146044575b600080fd5b604a6084565b60405180826fffffffffffffffffffffffffffffffff166fffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc60019081150290604051600060405180830381858888f19350505050151560e457fe5b602b9050905600a165627a7a723058202afd2e2ba780ca7060c0a7dfd1dc667ca3a8144fc6aed9b3042949c93dae154b0029";
        String abi = "[{\"constant\":false,\"inputs\":[],\"name\":\"test\",\"outputs\":[{\"name\":\"\",\"type\":\"uint128\"}],\"payable\":true,\"type\":\"function\"},{\"inputs\":[],\"payable\":false,\"type\":\"constructor\"}]";

        CallTransaction.Contract contract = new CallTransaction.Contract(abi);

        Map<String, CallTransaction.Function> functions = new HashMap<>();
        functions.put("test", contract.getByName("test"));
        return new TestContract(bytecode, runtimeBytecode, functions);
    }

    public static TestContract sendTest() {
        /*
        contract SendTest {
            function test() payable returns (uint128) {
                // send will fail and return false
                BadReceiver rec = new BadReceiver();
                assert(!rec.send(1));
                return 42;
            }
        }

        contract BadReceiver {
            function () payable {
                require(false);
            }
        }
        */

        String bytecode = "6060604052341561000f57600080fd5b6101868061001e6000396000f300606060405260043610610041576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063f8a8fd6d14610046575b600080fd5b61004e610088565b60405180826fffffffffffffffffffffffffffffffff166fffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6000806100936100f2565b604051809103906000f08015156100a957600080fd5b90508073ffffffffffffffffffffffffffffffffffffffff166108fc60019081150290604051600060405180830381858888f193505050501515156100ea57fe5b602a91505090565b60405160598061010283390190560060606040523415600e57600080fd5b603e80601b6000396000f300606060405260001515601057600080fd5b0000a165627a7a723058200a3db1a8a8f404159b6817ed55759b7dcf6a5e0251d99138b1ada59003ec09070029a165627a7a72305820b17c29a6a3bc72514126d3c0bd8c7e38f1b3efd4c52372e8e9c8893566e9dc3e0029";
        String runtimeBytecode = "606060405260043610610041576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff168063f8a8fd6d14610046575b600080fd5b61004e610088565b60405180826fffffffffffffffffffffffffffffffff166fffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6000806100936100f2565b604051809103906000f08015156100a957600080fd5b90508073ffffffffffffffffffffffffffffffffffffffff166108fc60019081150290604051600060405180830381858888f193505050501515156100ea57fe5b602a91505090565b60405160598061010283390190560060606040523415600e57600080fd5b603e80601b6000396000f300606060405260001515601057600080fd5b0000a165627a7a7230582061bb24cc4de5ab87b765f29445c63b927247fc249806572e30ff80aa346ac7030029a165627a7a723058207cc80a079a9012c50a71178622bdcfc38d08a600de4c4fcdf3868a5bd4b01dcc0029";
        String abi = "[{\"constant\":false,\"inputs\":[],\"name\":\"test\",\"outputs\":[{\"name\":\"\",\"type\":\"uint128\"}],\"payable\":true,\"type\":\"function\"},{\"inputs\":[],\"payable\":false,\"type\":\"constructor\"}]";

        CallTransaction.Contract contract = new CallTransaction.Contract(abi);

        Map<String, CallTransaction.Function> functions = new HashMap<>();
        functions.put("test", contract.getByName("test"));
        return new TestContract(bytecode, runtimeBytecode, functions);
    }

    public ProgramResult executeFunction(String functionName, BigInteger value, Object... args) {
        byte[] bytecode = Hex.decode(this.bytecode);
        byte[] encodedCall = this.functions.get(functionName).encode(args);

        return new RskTestFactory().createAndRunContract(bytecode, encodedCall, value);
    }
}
